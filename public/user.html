<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Secure E-Voting System</title>
    <style>
        /* Basic styles - will be expanded */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .panel {
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        .panel h2 {
            margin-bottom: 20px;
            color: #764ba2;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input[type="file"], .form-group input[type="text"], .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status-box {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .vote-receipt {
            background: #f0f8e7;
            border: 1px solid #c7e3b0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px; /* Ensure margin is applied if not already by class */
        }

        .ballot-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ballot-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .ballot-option.selected {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .ballot-option input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.2);
        }
        .btn-success { /* Specific style for success button if not globally defined */
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .btn-secondary { /* Specific style for secondary button if not globally defined */
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

         .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>User Dashboard</h1>
        <p>Manage your voting and personal documents.</p>
    </div>
    <a href="#" onclick="logoutUser()" class="logout-btn">Logout</a>

    <div class="container">
        <div id="userInfoPanel" class="panel">
            <h2>Welcome, <span id="userNameDisplay">User</span>!</h2>
            <p>Your Voter ID: <span id="voterIdDisplay">N/A</span></p>
            <!-- More user info can be added here -->
        </div>

        <!-- Voting Panel -->
        <div id="votingPanel" class="panel">
            <h2>üó≥Ô∏è Cast Your Vote</h2>
            <div id="ballotSection">
                <h3>2025 Presidential Election Ballot</h3>
                <p><strong>Instructions:</strong> Select one candidate. Your vote will be encrypted and anonymized.</p>

                <div id="ballotOptions">
                    <div class="ballot-option" role="radio" aria-checked="false" tabindex="0" onclick="selectCandidate('candidate1')">
                        <input type="radio" name="vote" value="candidate1" id="vote1" aria-labelledby="candidate1-label">
                        <div id="candidate1-label">
                            <strong>Prachanda</strong><br>
                            <small>Communist Party of Nepal</small>
                        </div>
                    </div>

                    <div class="ballot-option" role="radio" aria-checked="false" tabindex="0" onclick="selectCandidate('candidate2')">
                        <input type="radio" name="vote" value="candidate2" id="vote2" aria-labelledby="candidate2-label">
                        <div id="candidate2-label">
                            <strong>Sher Bahadaur Deuba</strong><br>
                            <small>Nepal Congress</small>
                        </div>
                    </div>

                    <div class="ballot-option" role="radio" aria-checked="false" tabindex="0" onclick="selectCandidate('candidate3')">
                        <input type="radio" name="vote" value="candidate3" id="vote3" aria-labelledby="candidate3-label">
                        <div id="candidate3-label">
                            <strong>Rabi Lamichhane</strong><br>
                            <small>Rastriya Swatantra Party</small>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="castVote()">Cast Vote</button>
                <button class="btn btn-secondary" onclick="clearVote()">Clear Selection</button>
            </div>
            <div id="voteStatus"></div>
            <div id="voteReceipt" class="vote-receipt" style="margin-top: 15px;"></div>
        </div>

        <!-- Document Upload Panel -->
        <div id="documentUploadPanel" class="panel">
            <h2>üìÑ Document Upload for Verification</h2>
            <div class="form-group">
                <label for="documentType">Document Type:</label>
                <select id="documentType">
                    <option value="">--Select Document Type--</option>
                    <option value="citizenship">Citizenship</option>
                    <option value="license">Driving License</option>
                    <option value="passport">Passport</option>
                </select>
            </div>
            <div class="form-group">
                <label for="documentFile">Select Document:</label>
                <input type="file" id="documentFile" accept=".pdf,.jpg,.jpeg,.png">
            </div>
            <button class="btn" onclick="uploadDocument()">Upload Document</button>
            <div id="uploadStatus"></div>
        </div>
    </div>

    <script>
        // Placeholder for user data
        let userData = null; // Will store {name, email, voterID}
        let authToken = null;

        function displayUserInfo() {
            const storedUser = localStorage.getItem('currentUser');
            authToken = localStorage.getItem('authToken');

            if (storedUser && authToken) {
                userData = JSON.parse(storedUser);
                document.getElementById('userNameDisplay').textContent = userData.name || 'User';
                document.getElementById('voterIdDisplay').textContent = userData.voterID || 'N/A';
                console.log("User data loaded:", userData);
            } else {
                console.log("No user data or token found. Redirecting to login.");
                window.location.href = '/index.html';
            }
        }

        function logoutUser() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            // localStorage.removeItem('tempPrivateKey'); // Clean up if it was stored
            console.log("User logged out.");
            window.location.href = '/index.html';
        }

        function uploadDocument() {
            if (!userData || !authToken) {
                alert("User session expired. Please log in again.");
                logoutUser();
                return;
            }
            const documentType = document.getElementById('documentType').value;
            const documentFile = document.getElementById('documentFile').files[0];
            const uploadStatus = document.getElementById('uploadStatus');

            if (!documentType) {
                uploadStatus.innerHTML = '<div class="status-box status-error">Please select a document type.</div>';
                return;
            }
            if (!documentFile) {
                uploadStatus.innerHTML = '<div class="status-box status-error">Please select a file to upload.</div>';
                return;
            }

            // FormData to send file
            const formData = new FormData();
            formData.append('documentType', documentType);
            formData.append('documentFile', documentFile);
            // voterID will be derived from authToken on the backend

            uploadStatus.innerHTML = '<div class="status-box status-info">Uploading...</div>';

            fetch('/api/user/upload-document', {
                method: 'POST',
                headers: {
                    // 'Content-Type': 'multipart/form-data' is set by the browser automatically for FormData
                    'Authorization': `Bearer ${authToken}`
                },
                body: formData
            })
            .then(async response => { // Mark async to use await for response.json() or response.text()
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await response.json() : await response.text();

                if (!response.ok) {
                    // Get error message from body or default to response status
                    const error = (data && (data.message || data.error)) || response.statusText;
                    throw new Error(error);
                }
                return data; // This will be the JSON object from the server on success
            })
            .then(data => {
                showStatus('uploadStatus', data.message || 'Document uploaded successfully. Awaiting verification.', 'success');
                document.getElementById('documentFile').value = ''; // Clear file input
                document.getElementById('documentType').selectedIndex = 0; // Reset dropdown
            })
            .catch(error => {
                console.error('Upload error:', error);
                showStatus('uploadStatus', `Upload failed: ${error.message}`, 'error');
            });
        }

        // --- START OF COPIED/ADAPTED VOTING FUNCTIONS ---

        // Utility to convert array buffer to base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // Utility to convert base64 to array buffer
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Select candidate
        function selectCandidate(candidateId) {
            document.querySelectorAll('.ballot-option').forEach(option => {
                option.classList.remove('selected');
                option.setAttribute('aria-checked', 'false');
            });

            const inputElementId = `vote${candidateId.slice(-1)}`; // e.g. vote1, vote2
            const input = document.getElementById(inputElementId);
            if (input) {
                input.checked = true;
                // Go up to the parent .ballot-option to add class
                let parent = input.parentElement;
                while(parent && !parent.classList.contains('ballot-option')) {
                    parent = parent.parentElement;
                }
                if (parent) {
                    parent.classList.add('selected');
                    parent.setAttribute('aria-checked', 'true');
                }
            } else {
                console.error("Could not find candidate input with ID:", inputElementId);
            }
        }

         // Cast vote
         async function castVote() {
            if (!userData || !authToken) {
                showStatus('voteStatus', 'User session not found. Please log in again.', 'error');
                // Optionally redirect to login after a delay
                // setTimeout(logoutUser, 3000);
                return;
            }

            const selectedVoteInput = document.querySelector('input[name="vote"]:checked');
            if (!selectedVoteInput) {
                showStatus('voteStatus', 'Please select a candidate.', 'error');
                return;
            }

            try {
                const voteDataPayload = {
                    candidate: selectedVoteInput.value,
                    timestamp: new Date().toISOString(),
                    voterIDHash: await hashData(userData.voterID) // Use voterID from userData
                };

                // Generate AES-GCM key
                const aesKey = await crypto.subtle.generateKey(
                    { name: "AES-GCM", length: 256 },
                    true,
                    ["encrypt", "decrypt"]
                );

                // Generate IV
                const iv = crypto.getRandomValues(new Uint8Array(12));

                // Encrypt vote data with AES-GCM
                const encryptedVote = await crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    aesKey,
                    new TextEncoder().encode(JSON.stringify(voteDataPayload))
                );
                const encryptedVoteB64 = arrayBufferToBase64(encryptedVote);

                // Export AES key
                const exportedAesKey = await crypto.subtle.exportKey("raw", aesKey);
                const aesKeyB64 = arrayBufferToBase64(exportedAesKey);
                const ivB64 = arrayBufferToBase64(iv);

                const response = await fetch('/api/cast-vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` // Use authToken
                    },
                    body: JSON.stringify({
                        encryptedVote: encryptedVoteB64,
                        aesKey: aesKeyB64,
                        iv: ivB64
                    })
                });

                const contentType = response.headers.get('content-type');
                if (!response.ok) {
                    const errorData = await response.text(); // Read as text first for better error messages
                    try {
                        const jsonError = JSON.parse(errorData); // Try to parse as JSON
                        throw new Error(jsonError.error || jsonError.message || errorData);
                    } catch (e) {
                        throw new Error(errorData); // Fallback to text if not JSON
                    }
                }

                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    throw new Error(`Unexpected response from server: ${responseText}`);
                }

                const { receipt } = await response.json();

                showVoteReceipt(receipt);
                showStatus('voteStatus', 'Vote cast successfully!', 'success');
                // Optionally disable voting button or hide section
                document.querySelector('#ballotSection .btn-success').disabled = true;
                document.querySelector('#ballotSection .btn-secondary').disabled = true;

            } catch (error) {
                console.error('Vote casting error:', error);
                showStatus('voteStatus', `Error casting vote: ${error.message}`, 'error');
            }
        }

        // Hash data
        async function hashData(data) {
            const msgBuffer = new TextEncoder().encode(data);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return arrayBufferToBase64(hashBuffer);
        }

        // Clear vote
        function clearVote() {
            document.querySelectorAll('input[name="vote"]').forEach(input => {
                input.checked = false;
            });
            document.querySelectorAll('.ballot-option').forEach(option => {
                option.classList.remove('selected');
                option.setAttribute('aria-checked', 'false');
            });
            showStatus('voteStatus', '', 'info'); // Clear any previous status
        }

        // Show vote receipt
        function showVoteReceipt(receipt) {
            const receiptHTML = `
                <h4>üßæ Vote Receipt</h4>
                <p><strong>Receipt ID:</strong> ${receipt.receiptID}</p>
                <p><strong>Timestamp:</strong> ${new Date(receipt.timestamp).toLocaleString()}</p>
                <p><strong>Block Hash:</strong> ${receipt.blockHash}</p>
                <p><small>Save this receipt ID to verify your vote later.</small></p>
            `;
            document.getElementById('voteReceipt').innerHTML = receiptHTML;
        }

        // Show status (generic function)
        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                const statusClass = `status-box status-${type}`;
                statusElement.innerHTML = `<div class="${statusClass}">${message}</div>`;
            } else {
                console.warn(`Status element with ID ${elementId} not found.`);
            }
        }
        // --- END OF COPIED/ADAPTED VOTING FUNCTIONS ---


        document.addEventListener('DOMContentLoaded', () => {
            displayUserInfo(); // This function now handles redirection if data is missing
            if (userData) { // Proceed only if userData was successfully loaded
                console.log('User dashboard initialized for:', userData.name);
                // Initialize voting section, etc. here
            }
        });
    </script>
</body>
</html>
