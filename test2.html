<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure E-Voting System - PKI Based</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 50px;
            padding: 5px;
        }

        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .nav-tab:hover {
            background: rgba(255,255,255,0.15);
        }

        .panel {
            display: none;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .status-box {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .key-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .certificate-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .vote-receipt {
            background: #f0f8e7;
            border: 1px solid #c7e3b0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .ledger-entry {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .ballot-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ballot-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .ballot-option.selected {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .ballot-option input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .admin-section {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-tab {
                margin: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Secure E-Voting System</h1>
            <p>PKI-Based Electronic Voting with Authentication, Integrity & Transparency</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPanel('registration')">Registration</button>
            <button class="nav-tab" onclick="showPanel('voting')">Voting</button>
            <button class="nav-tab" onclick="showPanel('admin')">Admin Panel</button>
            <button class="nav-tab" onclick="showPanel('ledger')">Public Ledger</button>
            <button class="nav-tab" onclick="showPanel('verification')">Verification</button>
        </div>

        <!-- Registration Panel -->
        <div id="registration" class="panel active">
            <h2>üÜî Voter Registration & Key Generation</h2>
            
            <div class="two-column">
                <div>
                    <h3>Step 1: Generate Key Pair</h3>
                    <div class="form-group">
                        <label for="voterName">Full Name:</label>
                        <input type="text" id="voterName" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="voterEmail">Email:</label>
                        <input type="email" id="voterEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="voterID">Voter ID:</label>
                        <input type="text" id="voterID" placeholder="Enter government issued ID">
                    </div>
                    <div class="form-group">
                        <label for="keySize">Key Size:</label>
                        <select id="keySize">
                            <option value="2048">RSA-2048 (Recommended)</option>
                            <option value="3072">RSA-3072 (High Security)</option>
                            <option value="4096">RSA-4096 (Maximum Security)</option>
                        </select>
                    </div>
                    <button class="btn" onclick="generateKeyPair()">Generate Key Pair</button>
                    <button class="btn btn-secondary" onclick="requestCertificate()">Request Certificate</button>
                </div>
                
                <div>
                    <h3>Step 2: Key Information</h3>
                    <div id="keyInfo"></div>
                    <div id="certificateStatus"></div>
                </div>
            </div>
        </div>

        <!-- Voting Panel -->
        <div id="voting" class="panel">
            <h2>üó≥Ô∏è Cast Your Vote</h2>
            
            <div id="authSection">
                <h3>Authentication Required</h3>
                <div class="form-group">
                    <label for="voterAuth">Enter your Voter ID:</label>
                    <input type="text" id="voterAuth" placeholder="Your registered voter ID">
                </div>
                <div class="form-group">
                    <label for="privateKeyAuth">Private Key (for signing):</label>
                    <textarea id="privateKeyAuth" rows="3" placeholder="Paste your private key here"></textarea>
                </div>
                <button class="btn" onclick="authenticateVoter()">Authenticate</button>
                <div id="authStatus"></div>
            </div>

            <div id="ballotSection" style="display: none;">
                <h3>2024 Presidential Election Ballot</h3>
                <p><strong>Instructions:</strong> Select one candidate. Your vote will be encrypted and anonymized.</p>
                
                <div id="ballotOptions">
                    <div class="ballot-option" onclick="selectCandidate('candidate1')">
                        <input type="radio" name="vote" value="candidate1" id="vote1">
                        <div>
                            <strong>John Smith (Democratic Party)</strong><br>
                            <small>Experience in public service, focus on education and healthcare</small>
                        </div>
                    </div>
                    
                    <div class="ballot-option" onclick="selectCandidate('candidate2')">
                        <input type="radio" name="vote" value="candidate2" id="vote2">
                        <div>
                            <strong>Sarah Johnson (Republican Party)</strong><br>
                            <small>Business background, emphasis on economy and security</small>
                        </div>
                    </div>
                    
                    <div class="ballot-option" onclick="selectCandidate('candidate3')">
                        <input type="radio" name="vote" value="candidate3" id="vote3">
                        <div>
                            <strong>Michael Brown (Independent)</strong><br>
                            <small>Environmental advocate, government reform platform</small>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="castVote()">Cast Vote</button>
                <button class="btn btn-secondary" onclick="clearVote()">Clear Selection</button>
                
                <div id="voteStatus"></div>
                <div id="voteReceipt"></div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin" class="panel">
            <h2>‚öôÔ∏è Election Administration</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalVoters">0</div>
                    <div class="stat-label">Registered Voters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalVotes">0</div>
                    <div class="stat-label">Votes Cast</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeCerts">0</div>
                    <div class="stat-label">Active Certificates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="revokedCerts">0</div>
                    <div class="stat-label">Revoked Certificates</div>
                </div>
            </div>

            <div class="two-column">
                <div class="admin-section">
                    <h3>Certificate Management</h3>
                    <div class="form-group">
                        <label for="pendingCerts">Pending Certificate Requests:</label>
                        <select id="pendingCerts" size="5">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="approveCertificate()">Approve Selected</button>
                    <button class="btn" onclick="rejectCertificate()">Reject Selected</button>
                    
                    <h4>Revoke Certificate</h4>
                    <div class="form-group">
                        <input type="text" id="revokeVoterID" placeholder="Voter ID to revoke">
                    </div>
                    <button class="btn btn-secondary" onclick="revokeCertificate()">Revoke Certificate</button>
                </div>
                
                <div class="admin-section">
                    <h3>Election Results</h3>
                    <button class="btn" onclick="tallyVotes()">Tally All Votes</button>
                    <button class="btn btn-success" onclick="publishResults()">Publish Results</button>
                    
                    <div id="resultsDisplay"></div>
                </div>
            </div>
            
            <div id="adminStatus"></div>
        </div>

        <!-- Public Ledger Panel -->
        <div id="ledger" class="panel">
            <h2>üìä Public Voting Ledger</h2>
            <p>This ledger contains anonymized voting records for public verification. Personal information has been stripped to maintain voter privacy.</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="ledgerEntries">0</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ledgerHash">N/A</div>
                    <div class="stat-label">Latest Block Hash</div>
                </div>
            </div>
            
            <button class="btn" onclick="refreshLedger()">Refresh Ledger</button>
            <button class="btn btn-secondary" onclick="exportLedger()">Export as JSON</button>
            
            <div id="ledgerDisplay"></div>
        </div>

        <!-- Verification Panel -->
        <div id="verification" class="panel">
            <h2>‚úÖ Vote Verification</h2>
            
            <div class="two-column">
                <div>
                    <h3>Verify Your Vote</h3>
                    <div class="form-group">
                        <label for="verifyReceipt">Vote Receipt ID:</label>
                        <input type="text" id="verifyReceipt" placeholder="Enter your vote receipt ID">
                    </div>
                    <button class="btn" onclick="verifyVote()">Verify Vote</button>
                    
                    <h3>Verify Election Integrity</h3>
                    <button class="btn btn-success" onclick="verifyElectionIntegrity()">Verify All Signatures</button>
                    <button class="btn btn-secondary" onclick="verifyBlockchain()">Verify Blockchain</button>
                </div>
                
                <div>
                    <h3>Verification Results</h3>
                    <div id="verificationResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for the voting system
        let voters = {};
        let certificates = {};
        let votes = [];
        let votingLedger = [];
        let pendingCertRequests = [];
        let currentUser = null;
        let electionResults = null;

        // Simulated cryptographic functions (in production, use Web Crypto API or libraries)
        function generateRSAKeyPair(keySize) {
            // Simulated key generation - in production use Web Crypto API
            const keyId = 'KEY_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const publicKey = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA${btoa(keyId + keySize)}
-----END PUBLIC KEY-----`;
            
            const privateKey = `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC${btoa(keyId + keySize + 'private')}
-----END PRIVATE KEY-----`;
            
            return { publicKey, privateKey, keyId };
        }

        function hashData(data) {
            // Simulated SHA-256 hash
            return 'sha256_' + btoa(data + Date.now()).substr(0, 32);
        }

        function signData(data, privateKey) {
            // Simulated digital signature
            return 'SIG_' + btoa(data + privateKey).substr(0, 64);
        }

        function verifySignature(data, signature, publicKey) {
            // Simulated signature verification
            return signature.startsWith('SIG_') && signature.length === 68;
        }

        function encryptData(data, key) {
            // Simulated AES encryption
            return 'ENC_' + btoa(data + key);
        }

        function decryptData(encryptedData, key) {
            // Simulated AES decryption
            if (encryptedData.startsWith('ENC_')) {
                return atob(encryptedData.substr(4)).replace(key, '');
            }
            return null;
        }

        // Panel navigation
        function showPanel(panelId) {
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(panelId).classList.add('active');
            event.target.classList.add('active');
            
            if (panelId === 'admin') {
                updateAdminStats();
            } else if (panelId === 'ledger') {
                refreshLedger();
            }
        }

        // Registration functions
        function generateKeyPair() {
            const name = document.getElementById('voterName').value;
            const email = document.getElementById('voterEmail').value;
            const voterID = document.getElementById('voterID').value;
            const keySize = document.getElementById('keySize').value;

            if (!name || !email || !voterID) {
                showStatus('keyInfo', 'Please fill in all required fields.', 'error');
                return;
            }

            if (voters[voterID]) {
                showStatus('keyInfo', 'Voter ID already exists. Please use a different ID.', 'error');
                return;
            }

            const keyPair = generateRSAKeyPair(parseInt(keySize));
            
            voters[voterID] = {
                name,
                email,
                voterID,
                keyPair,
                registered: new Date(),
                hasVoted: false,
                certificateStatus: 'pending'
            };

            const keyDisplay = `
                <div class="key-display">
                    <h4>üîë Your Key Pair Generated Successfully</h4>
                    <p><strong>Key ID:</strong> ${keyPair.keyId}</p>
                    <p><strong>Key Size:</strong> ${keySize} bits</p>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    
                    <h5>Public Key:</h5>
                    <div style="font-size: 10px; word-break: break-all; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        ${keyPair.publicKey}
                    </div>
                    
                    <h5>Private Key (Keep this secure!):</h5>
                    <div style="font-size: 10px; word-break: break-all; background: #fff3cd; padding: 10px; border-radius: 5px;">
                        ${keyPair.privateKey}
                    </div>
                </div>
            `;

            document.getElementById('keyInfo').innerHTML = keyDisplay;
            showStatus('certificateStatus', 'Key pair generated successfully. Click "Request Certificate" to proceed.', 'success');
        }

        function requestCertificate() {
            const voterID = document.getElementById('voterID').value;
            
            if (!voterID || !voters[voterID]) {
                showStatus('certificateStatus', 'Please generate a key pair first.', 'error');
                return;
            }

            const voter = voters[voterID];
            if (voter.certificateStatus !== 'pending') {
                showStatus('certificateStatus', 'Certificate request already submitted.', 'info');
                return;
            }

            // Add to pending requests
            pendingCertRequests.push({
                voterID: voter.voterID,
                name: voter.name,
                email: voter.email,
                publicKey: voter.keyPair.publicKey,
                requestDate: new Date(),
                status: 'pending'
            });

            voter.certificateStatus = 'requested';
            
            showStatus('certificateStatus', 'Certificate request submitted successfully. Awaiting admin approval.', 'success');
            updatePendingCertificates();
        }

        // Voting functions
        function authenticateVoter() {
            const voterID = document.getElementById('voterAuth').value;
            const privateKey = document.getElementById('privateKeyAuth').value;

            if (!voterID || !privateKey) {
                showStatus('authStatus', 'Please enter your Voter ID and Private Key.', 'error');
                return;
            }

            const voter = voters[voterID];
            if (!voter) {
                showStatus('authStatus', 'Voter ID not found. Please register first.', 'error');
                return;
            }

            if (!certificates[voterID] || certificates[voterID].status !== 'active') {
                showStatus('authStatus', 'No valid certificate found. Please ensure your certificate is approved.', 'error');
                return;
            }

            if (voter.hasVoted) {
                showStatus('authStatus', 'You have already voted in this election.', 'error');
                return;
            }

            // Simulate authentication challenge
            const challenge = 'AUTH_CHALLENGE_' + Date.now();
            const signature = signData(challenge, privateKey);
            
            if (verifySignature(challenge, signature, voter.keyPair.publicKey)) {
                currentUser = voter;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('ballotSection').style.display = 'block';
                showStatus('authStatus', `Welcome, ${voter.name}! You are now authenticated.`, 'success');
            } else {
                showStatus('authStatus', 'Authentication failed. Please check your private key.', 'error');
            }
        }

        function selectCandidate(candidateId) {
            document.querySelectorAll('.ballot-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.getElementById(candidateId === 'candidate1' ? 'vote1' : 
                                 candidateId === 'candidate2' ? 'vote2' : 'vote3').checked = true;
            
            event.currentTarget.classList.add('selected');
        }

        function castVote() {
            if (!currentUser) {
                showStatus('voteStatus', 'Please authenticate first.', 'error');
                return;
            }

            const selectedVote = document.querySelector('input[name="vote"]:checked');
            if (!selectedVote) {
                showStatus('voteStatus', 'Please select a candidate.', 'error');
                return;
            }

            const voteData = {
                candidate: selectedVote.value,
                timestamp: new Date(),
                voterID: currentUser.voterID // This will be anonymized
            };

            // Encrypt the vote
            const encryptionKey = 'ELECTION_KEY_2024';
            const encryptedVote = encryptData(JSON.stringify(voteData), encryptionKey);
            
            // Sign the vote
            const voteSignature = signData(encryptedVote, currentUser.keyPair.privateKey);
            
            // Create vote record (anonymized)
            const voteRecord = {
                voteID: 'VOTE_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                encryptedVote,
                signature: voteSignature,
                publicKeyHash: hashData(currentUser.keyPair.publicKey),
                timestamp: new Date(),
                verified: true
            };

            // Add to votes and ledger
            votes.push(voteRecord);
            votingLedger.push({
                blockID: votingLedger.length + 1,
                voteID: voteRecord.voteID,
                hash: hashData(JSON.stringify(voteRecord)),
                previousHash: votingLedger.length > 0 ? votingLedger[votingLedger.length - 1].hash : '0',
                timestamp: voteRecord.timestamp
            });

            // Mark voter as having voted
            currentUser.hasVoted = true;
            voters[currentUser.voterID].hasVoted = true;

            // Generate receipt
            const receipt = {
                receiptID: voteRecord.voteID,
                timestamp: voteRecord.timestamp,
                blockHash: hashData(JSON.stringify(voteRecord))
            };

            showVoteReceipt(receipt);
            showStatus('voteStatus', 'Your vote has been cast successfully and added to the blockchain!', 'success');
            
            // Clear the ballot
            setTimeout(() => {
                document.getElementById('ballotSection').style.display = 'none';
                document.getElementById('authSection').style.display = 'block';
                clearAuthForm();
            }, 3000);
        }

        function clearVote() {
            document.querySelectorAll('input[name="vote"]').forEach(input => {
                input.checked = false;
            });
            document.querySelectorAll('.ballot-option').forEach(option => {
                option.classList.remove('selected');
            });
        }

        function clearAuthForm() {
            document.getElementById('voterAuth').value = '';
            document.getElementById('privateKeyAuth').value = '';
            currentUser = null;
        }

        function showVoteReceipt(receipt) {
            const receiptHTML = `
                <div class="vote-receipt">
                    <h4>üßæ Vote Receipt</h4>
                    <p><strong>Receipt ID:</strong> ${receipt.receiptID}</p>
                    <p><strong>Timestamp:</strong> ${receipt.timestamp.toLocaleString()}</p>
                    <p><strong>Block Hash:</strong> ${receipt.blockHash}</p>
                    <p><small>Save this receipt ID to verify your vote later.</small></p>
                </div>
            `;
            document.getElementById('voteReceipt').innerHTML = receiptHTML;
        }

        // Admin functions
        function updateAdminStats() {
            document.getElementById('totalVoters').textContent = Object.keys(voters).length;
            document.getElementById('totalVotes').textContent = votes.length;
            document.getElementById('activeCerts').textContent = Object.values(certificates).filter(cert => cert.status === 'active').length;
            document.getElementById('revokedCerts').textContent = Object.values(certificates).filter(cert => cert.status === 'revoked').length;
            
            updatePendingCertificates();
        }

        function updatePendingCertificates() {
            const select = document.getElementById('pendingCerts');
            select.innerHTML = '';
            
            pendingCertRequests.filter(req => req.status === 'pending').forEach(req => {
                const option = document.createElement('option');
                option.value = req.voterID;
                option.textContent = `${req.name} (${req.voterID}) - ${req.requestDate.toLocaleDateString()}`;
                select.appendChild(option);
            });
        }

        function approveCertificate() {
            const select = document.getElementById('pendingCerts');
            const selectedVoterID = select.value;
            
            if (!selectedVoterID) {
                showStatus('adminStatus', 'Please select a certificate request to approve.', 'error');
                return;
            }

            const request = pendingCertRequests.find(req => req.voterID === selectedVoterID && req.status === 'pending');
            if (!request) {
                showStatus('adminStatus', 'Certificate request not found.', 'error');
                return;
            }

            // Generate X.509 certificate
            const certificate = {
                certID: 'CERT_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                voterID: selectedVoterID,
                publicKey: request.publicKey,
                issuer: 'Election Commission CA',
                subject: `CN=${request.name}, EMAIL=${request.email}, UID=${selectedVoterID}`,
                validFrom: new Date(),
                validTo: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year
                status: 'active',
                serialNumber: Math.floor(Math.random() * 1000000),
                signature: signData(request.publicKey + selectedVoterID, 'CA_PRIVATE_KEY')
            };

            certificates[selectedVoterID] = certificate;
            request.status = 'approved';
            voters[selectedVoterID].certificateStatus = 'approved';

            showStatus('adminStatus', `Certificate approved for ${request.name} (${selectedVoterID})`, 'success');
            updateAdminStats();
        }

        function rejectCertificate() {
            const select = document.getElementById('pendingCerts');
            const selectedVoterID = select.value;
            
            if (!selectedVoterID) {
                showStatus('adminStatus', 'Please select a certificate request to reject.', 'error');
                return;
            }

            const request = pendingCertRequests.find(req => req.voterID === selectedVoterID && req.status === 'pending');
            if (!request) {
                showStatus('adminStatus', 'Certificate request not found.', 'error');
                return;
            }

            request.status = 'rejected';
            voters[selectedVoterID].certificateStatus = 'rejected';

            showStatus('adminStatus', `Certificate rejected for ${request.name} (${selectedVoterID})`, 'info');
            updateAdminStats();
        }

        function revokeCertificate() {
            const voterID = document.getElementById('revokeVoterID').value;
            
            if (!voterID) {
                showStatus('adminStatus', 'Please enter a Voter ID to revoke.', 'error');
                return;
            }

            if (!certificates[voterID]) {
                showStatus('adminStatus', 'Certificate not found for this Voter ID.', 'error');
                return;
            }

            certificates[voterID].status = 'revoked';
            certificates[voterID].revokedDate = new Date();
            certificates[voterID].revokedReason = 'Revoked by administrator';

            showStatus('adminStatus', `Certificate revoked for Voter ID: ${voterID}`, 'success');
            document.getElementById('revokeVoterID').value = '';
            updateAdminStats();
        }

        function tallyVotes() {
            if (votes.length === 0) {
                showStatus('adminStatus', 'No votes to tally.', 'info');
                return;
            }

            const results = {};
            const encryptionKey = 'ELECTION_KEY_2024';

            votes.forEach(vote => {
                try {
                    const decryptedVote = decryptData(vote.encryptedVote, encryptionKey);
                    const voteData = JSON.parse(decryptedVote);
                    
                    if (!results[voteData.candidate]) {
                        results[voteData.candidate] = 0;
                    }
                    results[voteData.candidate]++;
                } catch (error) {
                    console.error('Error decrypting vote:', error);
                }
            });

            electionResults = results;
            displayResults();
        }

        function displayResults() {
            if (!electionResults) {
                document.getElementById('resultsDisplay').innerHTML = '<p>No results available. Please tally votes first.</p>';
                return;
            }

            const candidateNames = {
                'candidate1': 'John Smith (Democratic)',
                'candidate2': 'Sarah Johnson (Republican)',
                'candidate3': 'Michael Brown (Independent)'
            };

            let resultHTML = '<div class="status-box status-success"><h4>üìä Election Results</h4>';
            let totalVotes = 0;

            Object.values(electionResults).forEach(count => totalVotes += count);

            Object.entries(electionResults).forEach(([candidate, votes]) => {
                const percentage = ((votes / totalVotes) * 100).toFixed(1);
                resultHTML += `
                    <p><strong>${candidateNames[candidate] || candidate}:</strong> ${votes} votes (${percentage}%)</p>
                `;
            });

            resultHTML += `<p><strong>Total Votes:</strong> ${totalVotes}</p></div>`;
            document.getElementById('resultsDisplay').innerHTML = resultHTML;
        }

        function publishResults() {
            if (!electionResults) {
                showStatus('adminStatus', 'Please tally votes before publishing results.', 'error');
                return;
            }

            // In a real system, this would publish to a public blockchain or database
            showStatus('adminStatus', 'Election results have been published to the public ledger.', 'success');
            
            // Add results to ledger
            const resultsBlock = {
                blockID: votingLedger.length + 1,
                type: 'ELECTION_RESULTS',
                data: electionResults,
                hash: hashData(JSON.stringify(electionResults)),
                previousHash: votingLedger.length > 0 ? votingLedger[votingLedger.length - 1].hash : '0',
                timestamp: new Date()
            };
            
            votingLedger.push(resultsBlock);
        }

        // Ledger functions
        function refreshLedger() {
            document.getElementById('ledgerEntries').textContent = votingLedger.length;
            document.getElementById('ledgerHash').textContent = votingLedger.length > 0 ? 
                votingLedger[votingLedger.length - 1].hash.substr(0, 16) + '...' : 'N/A';

            const ledgerHTML = votingLedger.map(entry => `
                <div class="ledger-entry">
                    <h4>Block #${entry.blockID}</h4>
                    <p><strong>Type:</strong> ${entry.type || 'VOTE'}</p>
                    <p><strong>Vote ID:</strong> ${entry.voteID || 'N/A'}</p>
                    <p><strong>Hash:</strong> <code>${entry.hash}</code></p>
                    <p><strong>Previous Hash:</strong> <code>${entry.previousHash}</code></p>
                    <p><strong>Timestamp:</strong> ${entry.timestamp.toLocaleString()}</p>
                    ${entry.data ? `<p><strong>Data:</strong> ${JSON.stringify(entry.data)}</p>` : ''}
                </div>
            `).join('');

            document.getElementById('ledgerDisplay').innerHTML = ledgerHTML || '<p>No entries in the ledger yet.</p>';
        }

        function exportLedger() {
            const data = JSON.stringify(votingLedger, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `voting_ledger_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Verification functions
        function verifyVote() {
            const receiptID = document.getElementById('verifyReceipt').value;
            
            if (!receiptID) {
                showStatus('verificationResults', 'Please enter a receipt ID.', 'error');
                return;
            }

            const vote = votes.find(v => v.voteID === receiptID);
            const ledgerEntry = votingLedger.find(l => l.voteID === receiptID);

            if (!vote || !ledgerEntry) {
                showStatus('verificationResults', 'Receipt ID not found in the system.', 'error');
                return;
            }

            const verificationHTML = `
                <div class="status-box status-success">
                    <h4>‚úÖ Vote Verification Results</h4>
                    <p><strong>Vote ID:</strong> ${vote.voteID}</p>
                    <p><strong>Timestamp:</strong> ${vote.timestamp.toLocaleString()}</p>
                    <p><strong>Block ID:</strong> ${ledgerEntry.blockID}</p>
                    <p><strong>Signature Valid:</strong> ‚úÖ Yes</p>
                    <p><strong>In Blockchain:</strong> ‚úÖ Yes</p>
                    <p><strong>Hash Integrity:</strong> ‚úÖ Verified</p>
                    <p><em>Your vote has been successfully recorded and counted.</em></p>
                </div>
            `;

            document.getElementById('verificationResults').innerHTML = verificationHTML;
        }

        function verifyElectionIntegrity() {
            let validVotes = 0;
            let invalidVotes = 0;
            let verificationReport = '<div class="status-box status-info"><h4>üîç Election Integrity Report</h4>';

            votes.forEach(vote => {
                // In a real system, verify against actual public keys from certificates
                const isSignatureValid = verifySignature(vote.encryptedVote, vote.signature, 'mock_public_key');
                
                if (isSignatureValid) {
                    validVotes++;
                } else {
                    invalidVotes++;
                }
            });

            verificationReport += `
                <p><strong>Total Votes Checked:</strong> ${votes.length}</p>
                <p><strong>Valid Signatures:</strong> ${validVotes}</p>
                <p><strong>Invalid Signatures:</strong> ${invalidVotes}</p>
                <p><strong>Integrity Status:</strong> ${invalidVotes === 0 ? '‚úÖ PASSED' : '‚ùå FAILED'}</p>
            `;

            // Verify blockchain integrity
            let chainValid = true;
            for (let i = 1; i < votingLedger.length; i++) {
                if (votingLedger[i].previousHash !== votingLedger[i-1].hash) {
                    chainValid = false;
                    break;
                }
            }

            verificationReport += `
                <p><strong>Blockchain Integrity:</strong> ${chainValid ? '‚úÖ VALID' : '‚ùå COMPROMISED'}</p>
                </div>
            `;

            document.getElementById('verificationResults').innerHTML = verificationReport;
        }

        function verifyBlockchain() {
            let verificationReport = '<div class="status-box status-info"><h4>‚õìÔ∏è Blockchain Verification</h4>';
            
            if (votingLedger.length === 0) {
                verificationReport += '<p>No blocks to verify.</p></div>';
                document.getElementById('verificationResults').innerHTML = verificationReport;
                return;
            }

            let validBlocks = 0;
            let invalidBlocks = 0;

            votingLedger.forEach((block, index) => {
                let blockValid = true;
                
                // Verify hash
                const expectedHash = hashData(JSON.stringify({
                    blockID: block.blockID,
                    voteID: block.voteID,
                    data: block.data,
                    previousHash: block.previousHash,
                    timestamp: block.timestamp
                }));
                
                if (block.hash !== expectedHash) {
                    blockValid = false;
                }

                // Verify previous hash link (except for genesis block)
                if (index > 0 && block.previousHash !== votingLedger[index - 1].hash) {
                    blockValid = false;
                }

                if (blockValid) {
                    validBlocks++;
                } else {
                    invalidBlocks++;
                }
            });

            verificationReport += `
                <p><strong>Total Blocks:</strong> ${votingLedger.length}</p>
                <p><strong>Valid Blocks:</strong> ${validBlocks}</p>
                <p><strong>Invalid Blocks:</strong> ${invalidBlocks}</p>
                <p><strong>Chain Status:</strong> ${invalidBlocks === 0 ? '‚úÖ INTACT' : '‚ùå CORRUPTED'}</p>
                <p><strong>Genesis Block:</strong> ${votingLedger[0] ? '‚úÖ Present' : '‚ùå Missing'}</p>
                </div>
            `;

            document.getElementById('verificationResults').innerHTML = verificationReport;
        }

        // Utility functions
        function showStatus(elementId, message, type) {
            const statusClass = `status-${type}`;
            const statusHTML = `<div class="${statusClass}">${message}</div>`;
            document.getElementById(elementId).innerHTML = statusHTML;
        }

        // Initialize the system
        function initializeSystem() {
            // Create some demo data for testing
            const demoVoter = {
                name: 'Demo User',
                email: 'demo@example.com',
                voterID: 'DEMO001',
                keyPair: generateRSAKeyPair(2048),
                registered: new Date(),
                hasVoted: false,
                certificateStatus: 'approved'
            };

            voters['DEMO001'] = demoVoter;
            
            certificates['DEMO001'] = {
                certID: 'CERT_DEMO_001',
                voterID: 'DEMO001',
                publicKey: demoVoter.keyPair.publicKey,
                issuer: 'Election Commission CA',
                subject: `CN=${demoVoter.name}, EMAIL=${demoVoter.email}, UID=DEMO001`,
                validFrom: new Date(),
                validTo: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000),
                status: 'active',
                serialNumber: 123456,
                signature: signData(demoVoter.keyPair.publicKey + 'DEMO001', 'CA_PRIVATE_KEY')
            };

            console.log('Secure E-Voting System initialized');
            console.log('Demo voter created: DEMO001');
            console.log('Private key for testing:', demoVoter.keyPair.privateKey);
        }

        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>
